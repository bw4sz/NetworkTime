---
title: Niche overlap increases with increasing resource availability in a tropical
  plant-pollinator network.
author: "Ben Weinstein"
date: "Tuesday, October 14, 2014"
output:
  html_document:
    theme: spacelab
  word_document: default
---
```{r,echo=F}
paste("Run Completed at",Sys.time())
```

```{r,echo=FALSE,warning=FALSE,message=FALSE}
require(knitr)
library(R2jags)
require(reshape2)
require(ggplot2)
library(scales)
library(dplyr)
library(stringr)
require(picante)
require(igraph)
require(bipartite)
library(chron)
library(gridExtra)
library(doSNOW)
library(foreach)
#Set Dropbox Location
#setwd to dropbox
droppath<-"C:/Users/Ben/Dropbox/"

#Set github path
gitpath<-"C:/Users/Ben/Documents/NetworkTime/"

setwd(gitpath)

opts_chunk$set(message=FALSE,warning=FALSE,fig.height=9,fig.width=13,echo=FALSE,cache=TRUE,cache.path = 'NetworkTime_cache/', fig.path='figure/')

#source bayes functions
source("Bayesian/BayesFunctions.R")
```

************

```{r,fig.height=4,fig.width=8}
#Get flower transect data
full.fl<-read.csv("C:/Users/Ben/Dropbox/Thesis/Maquipucuna_SantaLucia/Results/FlowerTransects/FlowerTransectClean.csv")[,-1]

 #month should be capital 
colnames(full.fl)[colnames(full.fl) %in% "month"]<-"Month"

#group by month and replicate, remove date errors by making a max of 10 flowers, couple times where the gps places it in wrong transect by 1 to 2 meters. 
flower.month<-group_by(full.fl,Month,Year,Transect_R,Date_F) %>% dplyr::summarise(Flowers=sum(Total_Flowers,na.rm=TRUE))  %>% filter(Flowers>20)
  
#Make month abbreviation column, with the right order
flower.month$Month.a<-factor(month.abb[flower.month$Month],month.abb[c(1:12)])

#Make year factor column
flower.month$Year<-as.factor(flower.month$Year)

#get quantile for each transect
thresh<-melt(group_by(flower.month,Transect_R) %>% summarize(Threshold=quantile(log(Flowers),0.75)) )
flower.month<-merge(flower.month,thresh)
flower.month$High<-log(flower.month$Flowers)>flower.month$value
#plot
ggplot(flower.month,aes(x=Month.a,log(Flowers),shape=as.factor(Year),col=High)) + geom_point(size=3) + theme_bw()  + geom_smooth(aes(group=1)) + ylab("Flowers") + xlab("Month") + facet_wrap(~Transect_R,scales="free_y") + labs(shape="Year", y= "Log Available Flowers") + scale_x_discrete(breaks=month.abb[seq(1,12,2)]) + scale_color_manual(labels=c("Low","High"),values=c("black","red")) + labs(col="Resource Availability")

ggsave("Figures/AvailableFlowers.jpg",dpi=600,units="in",width=7,height=6)
ggsave("Figures/AvailableFlowers.svg",units="in",width=7,height=6)

```

****

**Figure 3. Measures of hummingbird plant interactions through time (points) as compared to a null model maintaining the number of observations (shaded region).The size of the point is proportional to the number of interactions measured for each month.**

```{r,fig.height=20,fig.width=13}
#Goal to create randomized networks for each month and redo the entire analysis

int<-read.csv(paste(droppath,"Thesis/Maquipucuna_SantaLucia/Results/Network/HummingbirdInteractions.csv",sep=""),row.names=1)
int$Year<-years(int$DateP)
int$Year[int$Year %in% 2012]<-2013

int[int$Year %in% 2013 & int$Month %in% 1,"Year"]<-2014

#break up network by two months
int.M<-split(int,list(int$Month,int$Year),drop=TRUE)

#remove months with less than 15 records
int.M<-int.M[sapply(int.M,nrow)>20]

#design null function
nullC<-function(x){
  x<-droplevels(x)
  N=nrow(x)
  month.inter<-t(table(x$Hummingbird,x$Iplant_Double))
  #month.interB<-(month.inter>0)*1

metricskeep<-c("connectance","niche overlap","togetherness","linkage density","partner diversity","mean number of shared partners","nestedness","number of compartments","weighted connectance")

true_stat<-networklevel(month.inter)
  
true_stat<-melt(true_stat)

true_stat$variable<-rownames(true_stat)

# Create 199 random matrixes
r.int<-permatfull(month.inter,times=200)

#Compute nestendness seperately.
nested.test<-nestedness(month.inter)

#Create a function that computes network metrics
null_total<-as.data.frame(
  t(sapply(r.int$perm,function(x){
  #Compute network statistics
    out<-networklevel(x)
    return(out)
    })))
#get the upper and lower 2.5th quantiles
null_total<-melt(null_total)
nullq<-group_by(null_total,variable) %>% summarize(Lower=quantile(value,0.025,na.rm=T),Upper=quantile(value,0.975,na.rm=T))

#add month
nullq$Month<-unique(x$Month)

#add Year
nullq$Year<-unique(x$Year)

colnames(nullq)<-c("Metric","Lower","Upper","Month","Year")

#append true information
out<-merge(nullq,true_stat,by.x="Metric",by.y="variable")
colnames(out)[colnames(out) %in% "value"]<-"True"
out$N<-N
return(out)}

#apply function to each month
cl<-makeCluster(20,"SOCK")
registerDoSNOW(cl)
runs<-foreach(x=1:length(int.M),.packages=c("bipartite","reshape2","dplyr")) %dopar% {nullC(int.M[[x]])}
stopCluster(cl)

dat<-rbind_all(runs)

#format date
dat$Date<-as.Date(paste(1,round(dat$Month),dat$Year,sep="/"),format="%d/%m/%Y")

#Take out plant metrics for the moment
datHL<-dat[!str_detect(dat$Metric,".LL"),]

#plot distribution of  values
p<-ggplot(datHL,aes(x=Date,fill=Metric)) + facet_wrap(~Metric,scales='free',ncol=4) + geom_ribbon(aes(ymin=Lower,ymax=Upper))
p<-p+ geom_point(aes(size=N,y=True)) + geom_line(aes(y=True)) 
p<-p+scale_fill_discrete(guide="none") + scale_x_date(breaks="3 months",label=date_format("%m")) + scale_size_continuous(range=c(2.5,5),"Observations") + labs(y="") + theme_bw()
print(p) 

ggsave("Figures/NullNetwork.jpg",dpi=600,quality=100,pointsize=14,height=10,width=12)
ggsave("Figures/NullNetwork.svg",height=10,width=12)

```

********

**Figure 4. Connectance, clustering and niche overlap as a function of available resources. Point size is proportional to number of interactions observed that month.**

```{r,fig.height=30,fig.width=15}
    
flowerMean<-group_by(flower.month,Month,Year,Transect_R) %>% summarize(mFlowers=mean(Flowers,na.rm=TRUE)) %>% group_by(Month,Year) %>% summarize(Flowers=sum(mFlowers,na.rm=TRUE))
  
#combine the flower totals and network metrics
  network.fl<-merge(flowerMean,datHL,by=c("Month","Year"))
  
  #Quick visualization 
  p<-ggplot(network.fl[,],aes(log(Flowers),y=True,shape=as.factor(Year))) + geom_point(aes(size=N)) + facet_wrap(~Metric,scale="free")  + geom_smooth(aes(group=1),method="lm") + theme_bw() + labs(col="Month",shape="Year",size="Interactions") + geom_text(aes(label=month.abb[Month]),hjust=-0.25,size=3) + scale_size_continuous(range=c(2.5,5),"Observations") + labs(x="Log Available Resources") + ylab("Score")
  print(p) 
ggsave("Figures/Network_Resources.jpg",height=15,width=15,dpi=300,units="in")
ggsave("Figures/Network_Resources.svg",height=10,width=10)

```

```{r}
#just a subset
p<-ggplot(network.fl[network.fl$Metric %in% c("mean.number.of.shared.partners.HL","H2","weighted NODF","connectance"),],aes(log(Flowers),y=True,shape=as.factor(Year))) + geom_point(aes(size=N)) + facet_wrap(~Metric,scale="free")  + geom_smooth(aes(group=1),method="lm") + theme_bw() + labs(col="Month",shape="Year",size="Interactions") + geom_text(aes(label=month.abb[Month]),hjust=-0.25,size=3) + scale_size_continuous(range=c(2.5,5),"Observations") + labs(x="Log Available Resources") + ylab("Score")
  print(p) 
ggsave("Figures/Network_ResourcesSubset.jpg",height=5,width=10,dpi=300,units="in")
ggsave("Figures/Network_ResourcesSubset.svg",height=5,width=10)
  
```

## Figure 5. Trait matching

* Hummingbirds in general match the corolla resources based on their bill length.

* This relationship changes over time

* During periods of high resource availability, trait matching is decreased. This is most pronounced in long billed species.

```{r,fig.width=9,fig.height=7,fig.align='center'}

#read in flower morphology data, comes from Nectar.R
fl.morph<-read.csv(paste(droppath,"Thesis/Maquipucuna_SantaLucia/Results/FlowerMorphology.csv",sep=""))

#First row is empty
fl.morph<-fl.morph[-1,]

#Bring in Hummingbird Morphology Dataset, comes from
hum.morph<-read.csv(paste(droppath,"Thesis/Maquipucuna_SantaLucia/Results/HummingbirdMorphology.csv",sep=""))

#Bring in Interaction Matrix from the Network.R script
int<-read.csv(paste(droppath,"Thesis/Maquipucuna_SantaLucia/Results/Network/HummingbirdInteractions.csv",sep=""),row.names=1)

#int$Month<-cut(int$Month,seq(0,12,2),labels=seq(1,11,2))

#Melt the interaction frame and match it with the traits
m.dat<-int[colnames(int) %in% c("ID","Video","Time","Hummingbird","Sex","TransectID","Transect_R","Iplant_Double","Pierce","DateP","Month","ele")]

m.dat$Year<-years(as.Date(m.dat$DateP))
#Fix spacing to match clades

#Which are matching
levels(m.dat$Hummingbird)[!levels(m.dat$Hummingbird) %in% hum.morph$English]

#This needs to be checked
#print(paste(levels(m.dat$Hummingbird)[!levels(m.dat$Hummingbird) %in% hum.morph$English],"not matched"))

#levels(m.dat$Hummingbird)[!levels(m.dat$Hummingbird) %in% hum.morph$English]<-c("Green-crowned Woodnymph")
m.datH<-merge(m.dat,hum.morph, by.x="Hummingbird",by.y="English")

#Merge to flowers
int.FLlevels<-levels(factor(m.datH$Iplant_Double))

#Which flowers are we missing info for?
missingTraits<-int.FLlevels[!int.FLlevels %in% fl.morph$X]

print(paste("Missing Trait Information:",missingTraits))
m.datH<-merge(m.datH,fl.morph, by.x="Iplant_Double",by.y="X")

#Drop piercing events, since they don't represent correlation
m.datH<-m.datH[!m.datH$Pierce %in% c("y","Y"),]
```

###Correlation

The correlation coefficient among bill and corolla lengths decreases as a function of available resources. The gray ribbon is a null randomization of the correlation structure for each month.

```{r}
#Time Cycles in correlation between bills and corollas

#Start by plotting monthly breaks of corolla matching

p<-ggplot(m.datH[!is.na(m.datH$Month),],aes(x=factor(Total_Culmen),TotalCorolla,col=Hummingbird)) + geom_point() 
p<-p + geom_smooth(aes(group=1),method="lm") + facet_wrap(~Month) + theme_bw()

p<-ggplot(m.datH[!is.na(m.datH$Month),],aes(x=Total_Culmen,TotalCorolla,col=Month)) + geom_point() 
p<-p + geom_smooth(aes(group=Month),method="lm") + theme_bw() + scale_color_continuous(low="blue",high="red")

#Difference Between Corolla and Bill Length of interactions measured
m.datH$BD<-m.datH$Total_Culmen-m.datH$TotalCorolla
p<-ggplot(m.datH,aes(y=BD,x=Hummingbird)) + geom_boxplot(position="dodge")
p<-p + coord_flip()

#######################################
#Compared usage to available resources
#######################################

sdat<-split(m.datH,list(m.datH$Month,m.datH$Year))

#atleast 10 observations
sdat<-sdat[sapply(sdat,nrow)>30]

######Correlation coefficient
#calculate it for all birds, then short and longbilled (30cm)
coeff<-rbind_all(lapply(sdat,function(x){
  mod.c<-cor(x$Total_Culmen,x$TotalCorolla)
  data.frame(Month=unique(x$Month),Year=as.numeric(as.character(unique(x$Year))),all=mod.c)
}))

#observed correlation
observed<-melt(coeff,measure.vars=c("all"))

#view observed and add date column, just call it the firt of the month for plotting
observed$Date<-as.Date(paste(observed$Month,1,observed$Year,sep="/"),format="%m/%d/%Y")
p<-ggplot(data=observed,aes(x=Date,y=value)) + geom_point() + geom_smooth(aes(group=variable)) 
p<-p+ theme_bw()  + labs(y="Correlation between Bill and Corolla Length",x="Available Resources") + labs(shape="Year")
p
ggsave("Figures/CorrelationTime.jpg",height=5,width=8,units="in",dpi=600)
ggsave("Figures/CorrelationTime.svg",height=5,width=8)

setwd(gitpath)
```

```{r,fig.height=7}

#Randomization of correlation

#Define replication function, shuffle corolla length values
shufflecor<-function(x=m.datH){
  #sample draw
  x$NewCorolla<-sample(x$TotalCorolla,replace=F)
  splitdat<-split(x,list(x$Month,x$Year))
  
  #atleast 20 observations
  splitdat<-splitdat[sapply(splitdat,nrow)>30]
  
  ######Correlation coefficient, which method to use?
  coef<-lapply(splitdat,function(y){
    mc<-cor(y$Total_Culmen,y$NewCorolla)
    
    out<-data.frame(Month=unique(y$Month),Year=as.numeric(as.character(unique(y$Year))),all=mc)
    return(out)}
    )
  nullc<-rbind_all(coef)
  return(nullc)
  }

nullcor<-replicate(100,shufflecor(m.datH),simplify = F)
nullcor<-rbind_all(nullcor)
#bind with resource dataframe
nullcor<-merge(flowerMean,nullcor,by=c("Month","Year"))

#Bind into one data frame
nullcorm<-melt(nullcor,measure.vars=c("all"))

#Get upper and lower quantile of null correlation
nullcorq<-dplyr::group_by(nullcorm,Month,Year,variable) %>% dplyr::summarize(Flowers=unique(Flowers),Upper=quantile(value,0.025),Lower=quantile(value,0.975))

#merge with original data
finaldat<-merge(nullcorq,observed)

#get data size for each month
sizeall<-group_by(m.datH,Month,Year) %>% mutate(Billtype=cut(Total_Culmen,breaks=c(0,60),labels=c("all"))) %>% group_by(Month,Year,Billtype) %>% summarize(N=n())

#bind size with observed and null data
finaldat<-merge(finaldat,sizeall)

p<-ggplot(data=finaldat,aes(x=log(Flowers),fill=variable))
p<-p+geom_ribbon(aes(ymin=Lower,ymax=Upper),fill="grey20",alpha=.15)
p<-p 
p<-p+ theme_bw() + labs(y="Correlaton between Bill and Corolla Length",x="Log Available Resources",shape="Year",y="")

p<-p + scale_y_continuous(breaks=c(-.3,0,.2,.4,.6,.8)) + scale_size_continuous(range=c(2.5,5)) + scale_fill_discrete(guide="none") + geom_smooth(aes(y=value),method="lm",fill="grey60",alpha=.8)  + labs(size="Observations") + geom_point(aes(y=value,shape=as.factor(Year),size=N)) + geom_text(aes(y=value,label=month.abb[Month]),size=3.5,vjust=-.5)
print(p)
ggsave("Figures/TraitMatching_Resource.jpg",height=6,width=8,units="in",dpi=600)
ggsave("Figures/TraitMatching_Resource.svg",height=6,width=8)

```


```{r}
#Read in data from Observed.Rmd
obsf<-read.csv("InputData/FinalObs.csv",row.names=1)

ggplot(obsf,aes(x=BFlowerA==1,y=Traitmatch,fill=Yobs > 0)) + geom_boxplot() + facet_wrap(~Hummingbird,nrow=3) + labs(x="Resource Availability",fill="Visited") + scale_x_discrete(labels=c("Low","High"))

```

#Distribtuion of corolla lengths over time

According to the transects

```{r}
full.morph<-merge(full.fl,fl.morph,by.x="Iplant_Double",by.y="Group.1")

ggplot(full.morph,aes(x=as.factor(Month),fill=as.factor(Year),y=TotalCorolla)) + geom_boxplot() + labs(fill="Year",y="Corolla Length (mm)",x="Month") + stat_smooth(aes(group=1))
ggsave("Figures/CorollaAvailability.jpg",dpi=300,height=5,width=6)
```

Corolla Selection compared to available lengths
```{r}

bm<-m.datH %>% dplyr::select(TotalCorolla,Month,Year,Iplant_Double,Hummingbird) %>% mutate(Type='Bird')

#need to remove background points that don't have species occurrences.

tm<-merge(bm,full.morph,by=c("Month","Year"))

#make sure
tm$Month<-factor(tm$Month,levels=1:12)
bm$Month<-factor(bm$Month,levels=1:12)

#replace with month names
levels(tm$Month)<-month.abb
levels(bm$Month)<-month.abb

ggplot() + geom_boxplot(data=bm,aes(x=Month,y=TotalCorolla),col='red',fill='red',alpha=.6) + stat_smooth(data=bm,aes(x=Month,group=1,y=TotalCorolla),fill='red',col='red')+ facet_wrap(~Hummingbird,ncol=4) + theme_bw()+ geom_boxplot(data=tm,aes(x=as.factor(Month),y=TotalCorolla.y),fill='black',alpha=.1)+ labs(fill="Year",y="Corolla Length (mm)",x="Month")+stat_smooth(data=tm,aes(group=1,x=Month,y=TotalCorolla.y),col='black',size=1) 
```

```{r}
save.image("NetworkTime.RData")
```
