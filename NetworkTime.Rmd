---
title: Appendix  B - Network Statistics.
author: "Ben Weinstein"
date: "2/1/2016"
output:
  html_document:
    toc: true
    number_sections: true
    theme: spacelab
    keep_md: true
---

```{r,echo=F}
paste("Run Completed at",Sys.time())
```

```{r,echo=FALSE,warning=FALSE,message=FALSE}
require(knitr)
library(R2jags)
require(reshape2)
require(ggplot2)
library(scales)
library(dplyr)
library(stringr)
require(picante)
require(igraph)
require(bipartite)
library(chron)
library(gridExtra)
library(doSNOW)
library(foreach)
#Set Dropbox Location
#setwd to dropbox
droppath<-"C:/Users/Ben/Dropbox/"

#Set github path
gitpath<-"C:/Users/Ben/Documents/NetworkTime/"

setwd(gitpath)

opts_chunk$set(message=FALSE,warning=FALSE,fig.height=5,fig.width=10,echo=FALSE,cache=F,cache.path = 'NetworkTime_cache/', fig.path='figure/',fig.align = 'center')

```


************

```{r}
#load data if needed
#load("NetworkTime.Rdata")
```

#Read in data

From Generate.Rmd

```{r,fig.height=20,fig.width=13}

int<-read.csv("InputData/FinalObs.csv",row.names=1)

#just presence records
int<-int[int$State=="Used",]

#Just use cameras
int<-int[int$Survey_Type=="Camera",]

#Daily interaction rate
ndays<-int %>% group_by(Iplant_Double) %>% summarize(n=length(unique(DateP))) 

#Total visits 
tvisits<-int %>% group_by(Hummingbird,Iplant_Double) %>% summarize(Total_Visits=sum(Yobs))
tvisits<-merge(tvisits,ndays,by="Iplant_Double")
tvisits$Rate<-round(tvisits$Total_Visits/tvisits$n,3)

```

#Overall Network

```{r}
#get order of interactions
hord<-tvisits %>% group_by(Hummingbird) %>% summarize(n=n()) %>% arrange(n)

tvisits$Hummingbird<-factor(tvisits$Hummingbird,levels=hord$Hummingbird)

pord<-tvisits %>% group_by(Iplant_Double) %>% summarize(n=n()) %>% arrange(desc(n))

tvisits$Iplant_Double<-factor(tvisits$Iplant_Double,levels=pord$Iplant_Double)

ggplot(tvisits,aes(y=Hummingbird,x=Iplant_Double,fill=Total_Visits)) + theme_bw() + geom_tile() + scale_fill_continuous(low="blue",high="red",na.value = "white") + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + xlab("Plant") 

#cast web
tweb<-acast(tvisits,Hummingbird~Iplant_Double,value.var="Rate",fill=0)
```

##Calculate overall statistics.

```{r}
overallmetrics<-networklevel(as.matrix(tweb),level="lower",index=c("weighted connectance","weighted NODF"))
#melt into data frame
overallmetrics<-data.frame(Metric=names(overallmetrics),value=overallmetrics)
```

## Permutation tests

We want to randomize the underlying total matrix, then recalculate daily interaction rates. We maintain column sums since cameras were placed at individual flowers, those identities are fixed through sampling. It is only the identity of hummingbirds that could vary in create realistic alternative networks. 

### Calculate randomized matrix

Maintaining the total number of observations, but shuffling where those visitations fall.

```{r}

null_metrics<-list()
for(x in 1:1000){
  
  #create duplicate dataframe
  nint<-int
  
  #Resample hummingbird identity
  nint$Hummingbird<-sample(levels(nint$Hummingbird),length(nint$Hummingbird),replace=T)
  
  #Calculate Daily interaction rate
  ndays<-nint %>% group_by(Iplant_Double) %>% summarize(n=length(unique(DateP))) 

  #Total visits 
  nvisits<-nint %>% group_by(Hummingbird,Iplant_Double) %>% summarize(Total_Visits=sum(Yobs))
  nvisits<-merge(nvisits,ndays,by="Iplant_Double")
  nvisits$Rate<-round(nvisits$Total_Visits/nvisits$n,3)
  
  #cast into network
  nweb<-acast(nvisits,Hummingbird~Iplant_Double,value.var="Rate",fill=0)
  nm<-networklevel(nweb,level="lower",index=c("weighted connectance","weighted NODF"))
  null_metrics[[x]]<-data.frame(Metric=names(nm),value=nm)
}

null_metrics<-melt(null_metrics)
ggplot(data=null_metrics,aes(x=value)) + geom_density(fill='grey40') + facet_wrap(~Metric,scales="free") + geom_vline(data=overallmetrics,aes(xintercept=value),col='red',linetype='dashed') + theme_bw()
```

```{r}
#Add overall network and measures underneath as a supp figure
num<-droplevels(null_metrics[null_metrics$Metric %in% c( "weighted connectance","weighted NODF"),])

ob<-droplevels(overallmetrics[overallmetrics$Metric %in% c("weighted connectance","weighted NODF"),])

levels(num$Metric)<-c("Connectance","Nestedness")
levels(ob$Metric)<-c("Connectance","Nestedness")

nulls<-ggplot(num,aes(x=value)) + geom_density(fill='grey40',alpha=0.5) + facet_wrap(~Metric,scales="free",nrow=1) + geom_vline(data=ob,aes(xintercept=value),col='red',linetype='dashed',size=1.5) + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

jpeg("Figures/Overall.jpeg",height=6,width=11,units="in",res=400)
grid.arrange(overall,nulls,heights=c(.7,.3)) 
dev.off()
```

#Temporal change in network

##View Sub-Networks

```{r,fig.height=15}

int.M<-split(int,int$Availability,drop = T)

p<-lapply(int.M,function(x){

  tweb<-table(x$Hummingbird,x$Iplant_Double)
  mtweb<-melt(tweb)
  colnames(mtweb)<-c("Hummingbird","Iplant_Double","Visits")
  
  #turn 0's to NA for plotting
  mtweb$Visits[mtweb$Visits==0]<-NA
  mtweb<-mtweb[!is.na(mtweb$Visits),]
  
  #get order of interactions
  hord<-mtweb %>% group_by(Hummingbird) %>% filter(!is.na(Visits)) %>% summarize(n=n()) %>% arrange(n) %>% .$Hummingbird
  
  mtweb$Hummingbird<-factor(mtweb$Hummingbird,levels=hord)
  
  pord<-mtweb %>% group_by(Iplant_Double) %>% filter(!is.na(Visits)) %>% summarize(n=n()) %>% arrange(desc(n)) %>% .$Iplant_Double
  
  mtweb$Iplant_Double<-factor(mtweb$Iplant_Double,levels=pord)
  
  ggplot(mtweb,aes(y=Hummingbird,x=Iplant_Double,fill=Visits)) + theme_bw() +geom_tile() + scale_fill_continuous(low="blue",high="red",na.value = "white") + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + xlab("Plant") + ggtitle(unique(x$Availability)) 
})

grid.arrange(p[[1]],p[[2]])
```


## Null function

```{r}
nullC<-function(x){
  x<-droplevels(x)
  N<-x %>% group_by(ID) %>% n_groups()
  month.inter<-t(table(x$Hummingbird,x$Iplant_Double))

true_stat<-networklevel(month.inter,index=c("weighted connectance","weighted NODF"),level="lower")
  
true_stat<-melt(true_stat)

true_stat$variable<-rownames(true_stat)

# Create 500 random matrixes
r.int<-permatfull(month.inter,times=500,fixedmar="none")

#Create a functi\on that computes network metrics
null_total<-as.data.frame(
  t(sapply(r.int$perm,function(x){
  #Compute network statistics
    out<-networklevel(x,index=c("weighted connectance","weighted NODF"),level="lower")
    return(out)
    })))

#get the upper and lower 5th quantiles
null_total<-melt(null_total)
nullq<-group_by(null_total,variable) %>% summarize(Lower=quantile(value,0.05,na.rm=T),Upper=quantile(value,0.95,na.rm=T))

colnames(nullq)<-c("Metric","Lower","Upper")

#append true information
out<-merge(nullq,true_stat,by.x="Metric",by.y="variable")
colnames(out)[colnames(out) %in% "value"]<-"True"
out$N<-N
return(out)}
```

###Apply function to each period

```{r}

cl<-makeCluster(2,"SOCK")
registerDoSNOW(cl)
runs<-foreach(x=1:length(int.M),.packages=c("bipartite","reshape2","dplyr")) %dopar% {nullC(int.M[[x]])}
stopCluster(cl)

names(runs)<-names(int.M)
datHL<-melt(runs,id.vars=colnames(runs[[1]]))

colnames(datHL)[6]<-"HL"
```


#Observed versus null values of nestedness, connectance within time periods

```{r}
p<-ggplot(datHL,aes(x=HL,fill=Metric)) + facet_wrap(~Metric,scales='free',ncol=3) + geom_linerange(aes(ymin=Lower,ymax=Upper))
p<-p+ geom_point(aes(size=N,y=True)) + geom_line(aes(y=True)) 
p<-p+scale_fill_discrete(guide="none") + scale_size_continuous(range=c(2.5,5),"Observations") + labs(y="") + theme_bw()
print(p) 
ggsave("Figures/NullNetwork.jpg",dpi=600,quality=100,pointsize=14,height=10,width=12)
ggsave("Figures/NullNetwork.svg",height=10,width=12)

```

#Randomize with respect to overall resource membership.  

```{r}
rHL<-function(){
  
  #shuffle
  int$rHL<-sample(int$Availability)
  rint.M<-split(int,int$rHL,drop = T)
  
  r<-lapply(rint.M,function(x){
  month.inter<-t(table(x$Hummingbird,x$Iplant_Double))
  true_stat<-networklevel(month.inter,index=c("weighted connectance","weighted NODF"),level="lower")
  true_stat<-melt(true_stat)
  true_stat$variable<-rownames(true_stat)
  return(melt(true_stat))
  })
  r<-melt(r)
  colnames(r)[3]<-"Availability"
  return(r)
}

randomN<-list()
for(x in 1:500){
randomN[[x]]<-rHL()
  }

names(randomN)<-1:500
randomN<-melt(randomN,id.vars=colnames(randomN[[1]]))

colnames(randomN)<-c("Metric","value","HL","Iteration")

#find quantiles
randomQ<-randomN %>% group_by(Metric,HL) %>% summarize(Lower=quantile(value,0.05),Upper=quantile(value,0.95))

levels(datHL$Metric)<-c("Nestedness","Connectance")
randomQ$Metric<-as.factor(randomQ$Metric)
levels(randomQ$Metric)<-c("Connectance","Nestedness")

#compare to observed values. 
p<-ggplot(datHL,aes(x=HL,fill=Metric)) + facet_wrap(~Metric,scales='free',ncol=3)
p<-p+ geom_point(aes(size=N,y=True)) + geom_line(aes(y=True)) 
p<-p+scale_fill_discrete(guide="none") + scale_size_continuous(range=c(2.5,5),"Observations") + labs(y="") + theme_bw()
p + geom_linerange(data=randomQ,col='red',aes(ymin=Lower,ymax=Upper)) + xlab("Resource Availability")
ggsave("Figures/NetworkChange.jpg",dpi=300,height=2.5,width=5)
```

```{r}
save.image("NetworkTime.RData")
```
