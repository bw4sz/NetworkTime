---
title: "Specialization decreases with increasing resource availability in a tropical plant-pollinator network."
author: "Ben Weinstein"
date: "Tuesday, October 14, 2014"
output:
  html_document:
    theme: spacelab
---

```{r,echo=FALSE,warning=FALSE,message=FALSE}
require(knitr)
require(reshape2)
require(ggplot2)
library(scales)
library(dplyr)
library(stringr)
require(picante)
require(igraph)
require(bipartite)
library(chron)

#Set Dropbox Location
#setwd to dropbox
droppath<-"C:/Users/Ben/Dropbox/"

#Set github path
gitpath<-"C:/Users/Ben/Documents/NetworkTime/"

setwd(gitpath)

opts_chunk$set(message=FALSE,warning=FALSE,fig.width=13,echo=FALSE,cache=TRUE,cache.path = 'NetworkTime_cache/', fig.path='figure/')
```

#Introduction

* Species mutualisms are under growing threat from climate change. 

* The tightness and fidelity of these interactions are shaped by evolutionary forces promoting specialization and generalization.

* In additon, the stability of these interactions depends on their relative specialization and generalization. Generalist interactions are likley to be more robust to climatic changes and maintain ecosystem services. 

* The dominant theory for pollinator specialization posits that selection should promote adaptations for the most effecive pollinator.

* However, this hypothesis ignores how a pollinator interactions with the surrounding biotic enviroment.


* In nature, biotic interactions occur against a shifting background of resource availability.

* In addition many specialist show temporal change in feeding behavior.

    * Liem's paradox.
    
* In this work we evaluate the effect of resource availability on niche overlap and specialization in Andean Hummingbirds.

* Nectar is the non-equilibirial resource with niche breadth measured as the diversity of plants visited and specialization the diversity of plants visited versus the number of available plants.

* Nectar availability changes drastically thoughout the year (Jun-Oct high availability)

* In light of this variation in resource abundance, we test two opposing theories exist for how pollinators should specialize for potential nectar resources. 

###Specialization should increase as available resources increases

* When there are an abundance of available resources, species do not suffer as much cost from competition. The plethora of option leads to decreased specialization as species maximize amount of time feeding and reduced time foraging for their specialized resource.
The observation that many morphological specialists forage as generalists during periods of high resource availability led to Liem’s Paradox in cichlids. Sloan-Wilson () suggested that the solution to this paradox is that the specialists fall back on private resources in time of low scarcity, which promotes greater morphological specialization.

  * MacArthur and Levins 1967, Abrams 1983), and niche partitioning (sensu MacArthur 1958, Pianka 1974, 1976, Schoener 1974) predict that stable coexistence of competing species is achieved through niche differenti- ation that reduces overlap among competitors. Thus, during periods of relative food scarcity, animals are expected to adjust feeding to reduce niche overlap with competitors.

###Specialization should decrease as available resources increases
* Optimal foraging suggests that as resource availability increases, species should specialize on resources which reduce handling time and increase efficiency. 

  * At times of low resource availablity species cannot be choosy, and must forgage on whatever plants are available. Species should prefer to partition resource space when possible, as to reduced competition among species. 


* We divide the plant-pollinator assemblage into temporal partitions to evaluate how co-occuring plants and pollinators partition resource space.

####Trait-Matching and Specialization

The above hypothesis predict a pattern of specialization and resources, but provide no direct mechanism by which species choose which resource for specialization. It has been repeated suggested that hummingbird foodplant specialization is mediated through bill-corolla phenotype matching. We therefore expect that as specialization increase, the strength of phenotypic matching should decrease. When given a choice, species should pick the flowers which reduce competition and closely match their bill morphology.

####Hummingbird network ecology

* Previous work
  * Maglianesi, M., Blüthgen, N., Böhning-Gaese, K., & Schleuning, M. (2014). Morphological traits determine specialization and resource use in plant-hummingbird networks in the Neotropics. Ecology, In press.
  * Vizentin-bugoni, J., Maruyama, P. K., & Sazima, M. (2014). Processes entangling interactions in communities: forbidden links are more important than abundance in a hummingbird–plant network. Proceedings of the Royal Society B: Biological Sciences, 281.

#Methods

# Specialization over time

We use two parallel methods to estimate the role of available resources in shaping specialization and trait matching in hummingbirds.

##Figure 1 - Conceptual figure for specialization and changing available resources.

##Figure 2 -

```{r}
#Write flower totals
fl.totals<-read.csv("C:/Users/Ben/Dropbox/Thesis/Maquipucuna_SantaLucia/Results/FlowerTransects/FlowerAvailability.csv",row.names=1)

#Make month abbreviation column, with the right order
fl.totals$Month.a<-factor(month.abb[fl.totals$Month],month.abb[c(1:12)])

#Make year factor column
fl.totals$Year<-as.factor(fl.totals$Year)

#Flowers at each elevation over time without Karen's data
ggplot(fl.totals,aes(x=Month.a,TotalFlowers,shape=as.factor(Year))) + geom_point(size=3) + theme_bw()  + geom_smooth(aes(group=1)) + ylab("Flowers") + xlab("Month") + facet_wrap(~Elev,scales="free_y")

```


```{r network,fig.height=15}
#Compute network measures
source("Network.R")
```


#Network measures over time
###Compare to randomization of the interaction matrix to account for differences in sampling. 

```{r}
#Goal to create randomized networks for each month and redo the entire analysis

#Read in interaction data
#setwd to dropbox
droppath<-"C:/Users/Ben/Dropbox/"
#Set github path
gitpath<-"C:/Users/Ben/Documents/NetworkTime/"

int<-read.csv(paste(droppath,"Thesis/Maquipucuna_SantaLucia/Results/Network/HummingbirdInteractions.csv",sep=""),row.names=1)
int$Year<-years(int$DateP)
int$Year[int$Year %in% 2012]<-2013

int[int$Year %in% 2013 & int$Month %in% 1,"Year"]<-2014

#break up network by month
int.M<-split(int,list(int$Month,int$Year),drop=TRUE)

#design null function
nullC<-function(x){
  x<-droplevels(x)
  month.inter<-table(x$Hummingbird,x$Iplant_Double)
  month.interB<-(month.inter>0)*1
  true_stat<-networklevel(month.interB,c("connectance","H2","cluster coefficient","niche overlap"))[c(1,3,4,6)]
  
true_stat<-melt(true_stat)

true_stat$variable<-rownames(true_stat)

# Create 199 random matrixes
r.int<-permatfull(month.inter,times=200)

#compute connectance and clustering on each

#Create a function that computes network metrics
null_total<-as.data.frame(
  t(sapply(r.int$perm,function(x){
#Compute netowkr statistics
out<-networklevel(x,c("connectance","H2","cluster coefficient","niche overlap"))[c(1,3,4,6)]
return(out)}))
)

#get the upper and lower 2.5th quantiles
nullq<-melt(apply(null_total,2,quantile,c(.025,.975)))

#add month
nullq$Month<-unique(x$Month)

#add Year
nullq$Year<-unique(x$Year)

colnames(nullq)<-c("Quantile","Metric","value","Month","Year")
#cast into desired format
castq<-dcast(nullq,Year+Month+Metric~Quantile)

#append true information
out<-merge(castq,true_stat,by.x="Metric",by.y="variable")
colnames(out)[colnames(out) %in% "value"]<-"True"

return(out)}

#apply function to each month
dat<-rbind_all(lapply(int.M,nullC))

#name the column of the percentages
colnames(dat)[4]<-"Lower"
colnames(dat)[5]<-"Upper"

#format date
dat$Date<-as.Date(paste(1,dat$Month,dat$Year,sep="/"),format="%d/%m/%Y")
#write.csv(dat,"Thesis/Maquipucuna_SantaLucia/Results/NullNetwork.csv")

#plot distribution of  values
p<-ggplot(dat,aes(x=Date,fill=Metric)) + geom_line(aes(y=True)) 
p<-p + geom_ribbon(aes(ymin=Lower,ymax=Upper),alpha=.4)+ facet_wrap(~Metric,nrow=2,scales="free") + theme_bw() 
p<-p+scale_fill_discrete(guide="none") + scale_x_date(breaks="3 months",label=date_format("%m/%y"))
print(p)

#ggsave("Thesis/Maquipucuna_SantaLucia/Results/NullNetwork.jpeg",dpi=300,height=8,width=8)
```

#Specialization, Connectance and Niche Overlap as a function of available resources.

```{r,fig.height=8}
  full.fl<-read.csv("C:/Users/Ben/Dropbox/Thesis/Maquipucuna_SantaLucia/Results/FlowerTransects/FlowerTransectClean.csv",row.names=1)
  
  #month should be capital 
  colnames(full.fl)[colnames(full.fl) %in% "month"]<-"Month"
  
  flower.month<-group_by(full.fl,Month,Year) %>% dplyr::summarise(Flowers=sum(Total_Flowers,na.rm=TRUE))
  
  #combine the flower totals and network metrics
  network.fl<-merge(flower.month,dat,by=c("Month","Year"))
  
  #Quick visualization 
  p<-ggplot(network.fl[!(network.fl$Month %in% 12 & network.fl$Year %in% 2014),],aes(log(Flowers),y=True,shape=as.factor(Year),col=as.factor(Month))) + facet_wrap(~Metric,scale="free")  + geom_smooth(aes(group=1),method="lm") + theme_bw() + labs(col="Month",shape="Year",size="Interactions") + geom_text(aes(label=month.abb[Month]),hjust=-0.25,size=4)
  print(p) 
```

## Trait matching

```{r,fig.width=9,fig.align='center'}

#read in flower morphology data, comes from Nectar.R
fl.morph<-read.csv(paste(droppath,"Thesis/Maquipucuna_SantaLucia/Results/FlowerMorphology.csv",sep=""))

#First row is empty
fl.morph<-fl.morph[-1,]

#Bring in Hummingbird Morphology Dataset, comes from
hum.morph<-read.csv(paste(droppath,"Thesis/Maquipucuna_SantaLucia/Results/HummingbirdMorphology.csv",sep=""))

#Bring in Interaction Matrix from the Network.R script
int<-read.csv(paste(droppath,"Thesis/Maquipucuna_SantaLucia/Results/Network/HummingbirdInteractions.csv",sep=""),row.names=1)

#Melt the interaction frame and match it with the traits
m.dat<-int[colnames(int) %in% c("ID","Video","Time","Hummingbird","Sex","TransectID","Transect_R","Iplant_Double","Pierce","DateP","Month","ele")]

m.dat$Year<-years(as.Date(m.dat$DateP))
#Fix spacing to match clades

#Which are matching
levels(m.dat$Hummingbird)[!levels(m.dat$Hummingbird) %in% hum.morph$English]

#This needs to be checked
#print(paste(levels(m.dat$Hummingbird)[!levels(m.dat$Hummingbird) %in% hum.morph$English],"not matched"))

#levels(m.dat$Hummingbird)[!levels(m.dat$Hummingbird) %in% hum.morph$English]<-c("Green-crowned Woodnymph")
m.datH<-merge(m.dat,hum.morph, by.x="Hummingbird",by.y="English")

#Merge to flowers
int.FLlevels<-levels(factor(m.datH$Iplant_Double))

#Which flowers are we missing info for?
missingTraits<-int.FLlevels[!int.FLlevels %in% fl.morph$X]

print(paste("Missing Trait Information:",missingTraits))
m.datH<-merge(m.datH,fl.morph, by.x="Iplant_Double",by.y="X")

#Drop piercing events, since they don't represent correlation

m.datH<-m.datH[!m.datH$Pierce %in% c("y","Y"),]

#Time Cycles


#Start by plotting monthly breaks of corolla matching

p<-ggplot(m.datH[!is.na(m.datH$Month),],aes(x=factor(Bill),TotalCorolla,col=Hummingbird)) + geom_point() 
p<-p + geom_smooth(aes(group=1),method="lm") + facet_wrap(~Month) + theme_bw()
#ggsave("Thesis/Maquipucuna_SantaLucia/Results/Phenotype/Matching_TimeGroup.svg")

p<-ggplot(m.datH[!is.na(m.datH$Month),],aes(x=Bill,TotalCorolla,col=Month)) + geom_point() 
p<-p + geom_smooth(aes(group=Month),method="lm") + theme_bw() + scale_color_continuous(low="blue",high="red")


#####################################################################
#Difference Between Corolla and Bill Length of interactions measured
#####################################################################

m.datH$BD<-m.datH$Bill-m.datH$TotalCorolla
p<-ggplot(m.datH,aes(y=BD,x=Hummingbird)) + geom_boxplot(position="dodge")
p<-p + coord_flip()

####################################################################
#Compared usage to available resources
####################################################################

full.fl<-read.csv("C:/Users/Ben/Dropbox/Thesis/Maquipucuna_SantaLucia/Results/FlowerTransects/FlowerTransectClean.csv",row.names=1)

#month should be capital 
colnames(full.fl)[colnames(full.fl) %in% "month"]<-"Month"
flower.month<-group_by(full.fl,Month,Year) %>% dplyr::summarise(Flowers=sum(Total_Flowers,na.rm=TRUE))

sdat<-split(m.datH,list(m.datH$Month,m.datH$Year))

#atleast 10 observations
sdat<-sdat[sapply(sdat,nrow)>30]

######Correlation coefficient, which method to use?
coeff<-rbind_all(lapply(sdat,function(x){
  mod.c<-cor.test(x$Bill,x$TotalCorolla)
  data.frame(Month=unique(x$Month),Year=as.numeric(as.character(unique(x$Year))),cor=mod.c$estimate,p=mod.c$p.value)
}))

nStats<-merge(flower.month,coeff,by=c("Month","Year"))

p<-ggplot(data=nStats,aes(x=log(Flowers),y=cor,shape=as.factor(Year))) + geom_point(size=3) + geom_smooth(method="lm",aes(group=1)) #+ geom_text(size=3.5,vjust=-.5)
p<-p+ theme_bw()  + labs(y="Cor (Bill~Corolla)",x="Available Resources") + labs(shape="Year")
p<-p + geom_text(aes(label=month.abb[Month]),size=3.5,vjust=-.5)


setwd(gitpath)

##
#Randomization of correlation
##

#Define replication function, shuffle corolla length values
shufflecor<-function(x){
  #sample draw
  m.datH$NewCorolla<-sample(m.datH$TotalCorolla,replace=F)
  
  sdat<-split(m.datH,list(m.datH$Month,m.datH$Year))
  
  #atleast 10 observations
  sdat<-sdat[sapply(sdat,nrow)>30]
  
  ######Correlation coefficient, which method to use?
  coeff<-rbind_all(lapply(sdat,function(x){
    mod.c<-cor.test(x$Bill,x$NewCorolla)
    data.frame(Month=unique(x$Month),Year=as.numeric(as.character(unique(x$Year))),cor=mod.c$estimate,p=mod.c$p.value)
  }))
  
  nStats<-merge(flower.month,coeff,by=c("Month","Year"))
}

nullcor<-replicate(10,shufflecor(),simplify = F)
for(x in 1:length(nullcor)){
  nullcor[[x]]$Iteration<-x
}

#Bind into one data frame
nullcor<-rbind_all(nullcor)

#Get upper and lower quantile of null correlation
nullcorq<-dplyr::group_by(nullcor,Month,Year) %>% summarize(Flowers=unique(Flowers),Upper=quantile(cor,0.025),Lower=quantile(cor,0.975))


#merge with original data
finaldat<-merge(nullcorq,nStats)

p<-ggplot(data=finaldat,aes(x=log(Flowers))) 
p<-p+geom_ribbon(aes(ymin=Lower,ymax=Upper),alpha=0.5)
p<-p + geom_point(aes(y=cor,shape=as.factor(Year)),size=3) + geom_smooth(method="lm",aes(group=1,y=cor)) 
p<-p+ theme_bw()  + labs(y="Cor (Bill~Corolla)",x="Available Resources") + labs(shape="Year")
p<-p + geom_text(aes(y=cor,label=month.abb[Month]),size=3.5,vjust=-.5)
print(p)
```

#Results

#Discussion

##Comparable literature
* Correa, S., & Winemiller, K. (2014). Niche partitioning among frugivorous fishes in response to fluctuating resources in the Amazonian floodplain forest. Ecology, 95(1), 210–224.

  * In general, dietary shifts in response to changes in the availability of preferred foods reduced interspecific niche overlap and may be a mechanism that facilitates coexistence in this species-rich fish assem- blage. During the period of greatest fruit production, diets of all six species were dominated, to varying degrees, by fruits and seeds, yielding broadly overlap- ping trophic niches among species.
  
* Trait packing, coexsitance and tropical specialization
  * This niche partitioning mechanism is central to many explanations of the latitudinal gradient in species diversity, i.e that greater resources lead to finer subdivision of niche space, and promotes reproductive isolation. 
  
  * Dalsgaard, B., Magård, E., Fjeldså, J., Martín González, A. M., Rahbek, C., Olesen, J. M., … Svenning, J.-C. (2011). Specialization in plant-hummingbird networks is associated with species richness, contemporary precipitation and quaternary climate-change velocity. PloS One, 6(10), e25891. doi:10.1371/journal.pone.0025891
    * Historical effect on specialization.
